{% extends 'base.html' %}

{% block title %}Community Locator - Pravash{% endblock %}

{% block extra_head %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<style>
    #map { width: 100%; height: 100%; min-height: 256px; }
    .leaflet-popup-content-wrapper { border-radius: 12px; }
    .leaflet-popup-content { margin: 12px; font-family: 'Plus Jakarta Sans', sans-serif; }
</style>
{% endblock %}

{% block header %}
<header class="flex items-center justify-between px-6 py-4">
    <button onclick="history.back()" class="w-10 h-10 flex items-center justify-center rounded-full bg-white dark:bg-card-dark border border-slate-200 dark:border-slate-800 shadow-sm active:scale-95 transition-transform">
        <span class="material-icons-round">arrow_back_ios_new</span>
    </button>
    <h1 class="text-lg font-bold tracking-tight">Community Locator</h1>
    <button class="w-10 h-10 flex items-center justify-center rounded-full bg-white dark:bg-card-dark border border-slate-200 dark:border-slate-800 shadow-sm">
        <span class="material-icons-round">more_horiz</span>
    </button>
</header>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Search -->
    <form method="get" class="relative group">
        <div class="absolute inset-y-0 left-4 flex items-center pointer-events-none">
            <span class="material-icons-round text-slate-400">search</span>
        </div>
        <input name="q" value="{{ request.GET.q|default:'' }}" class="w-full h-14 pl-12 pr-12 rounded-2xl border-none bg-white dark:bg-card-dark shadow-sm focus:ring-2 focus:ring-primary transition-all text-sm placeholder:text-slate-400" placeholder="Search by city (e.g. Dubai, Doha)" type="text"/>
        <div class="absolute inset-y-0 right-4 flex items-center">
            <button type="submit" class="material-icons-round text-slate-400 hover:text-primary">tune</button>
        </div>
    </form>

    <!-- Interactive Leaflet Map -->
    <div class="relative w-full h-64 rounded-3xl overflow-hidden shadow-sm border border-slate-200/50 dark:border-slate-800/50">
        <div id="map"></div>
        <div class="absolute bottom-4 right-4 flex flex-col gap-2 z-[1000]">
            <button onclick="recenterMap()" class="w-10 h-10 bg-white dark:bg-card-dark rounded-xl flex items-center justify-center shadow-md active:scale-95 transition-transform">
                <span class="material-icons-round text-slate-600 dark:text-slate-300">my_location</span>
            </button>
        </div>
    </div>

    <!-- Nearby Communities -->
    <div class="flex items-center justify-between">
        <h2 class="text-xl font-bold tracking-tight">Nearby Communities</h2>
        <span class="text-primary text-sm font-semibold">{{ communities|length }} Found</span>
    </div>

    <div class="space-y-4">
        {% for community in communities %}
        <div class="bg-white dark:bg-card-dark p-5 rounded-3xl border border-slate-100 dark:border-slate-800 shadow-sm flex flex-col gap-4">
            <div class="flex justify-between items-start">
                <div class="flex gap-4">
                    <div class="w-14 h-14 rounded-2xl bg-primary/10 dark:bg-primary/20 flex items-center justify-center">
                        <span class="material-icons-round text-primary text-3xl">{% if community.community_type == 'welfare' %}volunteer_activism{% elif community.community_type == 'religious' %}temple_buddhist{% elif community.community_type == 'professional' %}work{% else %}groups{% endif %}</span>
                    </div>
                    <div>
                        <h3 class="font-bold text-lg">{{ community.name }}</h3>
                        <div class="flex items-center gap-1 text-slate-500 dark:text-slate-400 text-sm">
                            <span class="material-icons-round text-[16px]">location_on</span>
                            <span>{{ community.city }}{% if community.country %}, {{ community.country }}{% endif %}</span>
                        </div>
                    </div>
                </div>
            </div>
            {% if community.contact_person or community.operating_hours %}
            <div class="grid grid-cols-2 gap-4 py-2 border-t border-dashed border-slate-200 dark:border-slate-800">
                {% if community.contact_person %}
                <div>
                    <p class="text-[11px] uppercase tracking-wider text-slate-400 font-bold">Contact Person</p>
                    <p class="font-semibold text-sm">{{ community.contact_person }}</p>
                </div>
                {% endif %}
                {% if community.operating_hours %}
                <div>
                    <p class="text-[11px] uppercase tracking-wider text-slate-400 font-bold">Available</p>
                    <p class="font-semibold text-sm text-green-500 flex items-center gap-1">
                        <span class="w-2 h-2 rounded-full bg-green-500"></span> {{ community.operating_hours }}
                    </p>
                </div>
                {% endif %}
            </div>
            {% endif %}
            <div class="flex gap-3">
                {% if community.phone %}
                <a href="tel:{{ community.phone }}" class="flex-1 h-12 bg-primary text-white rounded-2xl font-bold flex items-center justify-center gap-2 active:scale-95 transition-transform">
                    <span class="material-icons-round text-[18px]">call</span> Contact
                </a>
                {% endif %}
            </div>
        </div>
        {% empty %}
        <div class="bg-white dark:bg-card-dark p-8 rounded-3xl border border-slate-100 dark:border-slate-800 shadow-sm text-center">
            <span class="material-icons-round text-slate-300 text-4xl">search_off</span>
            <p class="text-sm text-slate-400 mt-2">No communities found. Try a different search.</p>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
    // Initialize map centered on user's location
    let userLat = {{ user_lat }};
    let userLon = {{ user_lon }};
    const locationSharing = {{ location_sharing|lower }};
    const map = L.map('map').setView([userLat, userLon], 12);

    // Add OpenStreetMap tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 19
    }).addTo(map);

    // User location marker (blue pulse)
    const userIcon = L.divIcon({
        className: 'custom-user-marker',
        html: '<div style="width: 14px; height: 14px; background: #3B82F6; border: 3px solid white; border-radius: 50%; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>',
        iconSize: [20, 20],
        iconAnchor: [10, 10]
    });
    let userMarker = L.marker([userLat, userLon], { icon: userIcon })
        .addTo(map)
        .bindPopup('<strong>Your Location</strong><br>{{ display_country }}');

    // Update with real geolocation if location sharing is enabled
    if (locationSharing && navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            userLat = position.coords.latitude;
            userLon = position.coords.longitude;
            
            // Update map view
            map.setView([userLat, userLon], 12);
            
            // Update user marker
            map.removeLayer(userMarker);
            userMarker = L.marker([userLat, userLon], { icon: userIcon })
                .addTo(map)
                .bindPopup('<strong>Your Location</strong>');
        }, function(error) {
            console.log('Geolocation error:', error.message);
        });
    }

    // Community markers
    const communities = {{ community_markers|safe }};
    communities.forEach(function(community) {
        const communityIcon = L.divIcon({
            className: 'custom-community-marker',
            html: '<div style="width: 12px; height: 12px; background: #7CB342; border: 2px solid white; border-radius: 50%; box-shadow: 0 2px 6px rgba(0,0,0,0.3);"></div>',
            iconSize: [16, 16],
            iconAnchor: [8, 8]
        });
        
        const marker = L.marker([community.lat, community.lon], { icon: communityIcon }).addTo(map);
        
        let popupContent = `<div class="text-sm">
            <strong class="block mb-1">${community.name}</strong>
            <span class="text-xs text-gray-600">${community.city}</span>`;
        
        if (community.phone) {
            popupContent += `<br><a href="tel:${community.phone}" class="text-xs text-primary font-semibold mt-1 inline-block">ðŸ“ž ${community.phone}</a>`;
        }
        
        popupContent += `</div>`;
        marker.bindPopup(popupContent);
    });

    // Recenter map function
    function recenterMap() {
        map.setView([userLat, userLon], 12);
        userMarker.openPopup();
    }

    // Fix map rendering after tab changes or window resize
    setTimeout(function() {
        map.invalidateSize();
    }, 100);
</script>
{% endblock %}
