{% extends 'base.html' %}

{% block title %}Emergency SOS Activation - Pradesh Setu{% endblock %}

{% block extra_head %}
<style>
    .pulse-animation {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    @keyframes pulse {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.8; transform: scale(0.98); }
    }
    .sos-ripple { position: relative; }
    .sos-ripple::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 100%;
        height: 100%;
        background: #EF4444;
        border-radius: 9999px;
        z-index: -1;
        animation: ripple 2s infinite;
    }
    @keyframes ripple {
        0% { width: 100%; height: 100%; opacity: 0.4; }
        100% { width: 160%; height: 160%; opacity: 0; }
    }
</style>
{% endblock %}

{% block nav_sos_class %}text-danger font-bold{% endblock %}

{% block header %}
<div class="px-6 py-4 flex justify-between items-center">
    <button onclick="history.back()" class="w-10 h-10 flex items-center justify-center rounded-full bg-white dark:bg-zinc-800 ios-shadow">
        <span class="material-icons-round">chevron_left</span>
    </button>
    <h1 class="text-lg font-bold tracking-tight">Emergency SOS</h1>
    <button class="w-10 h-10 flex items-center justify-center rounded-full bg-white dark:bg-zinc-800 ios-shadow text-danger">
        <span class="material-icons-round">info</span>
    </button>
</div>
{% endblock %}

{% block content %}
<!-- SOS Button Area -->
<div class="flex-1 flex flex-col items-center justify-center text-center space-y-12 py-8">
    <div class="space-y-2">
        <h2 class="text-2xl font-bold">Emergency Assistance</h2>
        <p class="text-slate-500 dark:text-slate-400 text-sm leading-relaxed">
            Immediate help will be dispatched. Your location will be shared with the Embassy and your emergency contacts.
        </p>
    </div>
    <div class="relative flex items-center justify-center w-64 h-64">
        <button class="sos-ripple w-52 h-52 bg-danger rounded-full flex flex-col items-center justify-center text-white ios-shadow active:scale-95 transition-transform duration-150 z-10 group" id="sosButton">
            <span class="material-icons-round text-6xl mb-2">emergency</span>
            <span class="text-lg font-extrabold uppercase tracking-widest px-4 text-center">Hold to Activate SOS</span>
        </button>
    </div>
    <div class="hidden animate-bounce flex items-center space-x-2 bg-red-50 dark:bg-red-900/20 px-4 py-2 rounded-full border border-red-200 dark:border-red-800/50" id="statusMessage">
        <div class="w-2 h-2 bg-danger rounded-full pulse-animation"></div>
        <p class="text-danger font-semibold text-sm">Sending Location to Embassy &amp; Family...</p>
    </div>
</div>

<!-- Location Info -->
<div class="bg-white dark:bg-zinc-800 rounded-3xl p-4 ios-shadow space-y-4 mb-6">
    <div class="flex justify-between items-center">
        <div class="flex items-center space-x-2">
            <span class="material-icons-round text-danger">location_on</span>
            <span class="font-semibold">Current Location</span>
        </div>
        <span class="text-[10px] bg-slate-100 dark:bg-slate-800 px-2 py-1 rounded-full text-slate-500">GPS ACTIVE</span>
    </div>
    <div class="relative h-44 rounded-2xl overflow-hidden bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700">
        <img alt="Map showing current location" class="w-full h-full object-cover opacity-50 dark:opacity-30 grayscale" src="https://lh3.googleusercontent.com/aida-public/AB6AXuA4aYf5PPAFmggqlgdh9_O9aJ326ju5Pyl9_omasCzpLsFfRSqOM40YhupzV3KDr3U-cE1jrIKzGVGhyDSqgadKqWDMXyA_iWkf-wCivI9Ooj5wtSg4WTq-yfCjiS632ai7w-4xbRbSVQdL_XJnaOT5KHAjTrmiziFLfot5Pqcd_mz3Z2HRQ9zkgoTd-S7SjyirPiVdWAKd-YHjRjlj3jXKDlVq7oJli5WRMwHyjFieEDxC4IXOMwt_g2hi2bjXQ7Rs-pGN89rwLOw"/>
        <div class="absolute inset-0 flex items-center justify-center">
            <div class="relative w-8 h-8 flex items-center justify-center">
                <div class="absolute inset-0 bg-blue-500 rounded-full opacity-30 animate-ping"></div>
                <div class="relative w-3 h-3 bg-blue-600 rounded-full border-2 border-white"></div>
            </div>
        </div>
        <div class="absolute bottom-3 left-3 bg-white/90 dark:bg-slate-900/90 backdrop-blur-md px-3 py-1.5 rounded-lg text-[11px] font-mono shadow-sm">
            Lat: 27.7172&deg; N, Lon: 85.3240&deg; E
        </div>
    </div>
    <div class="grid grid-cols-2 gap-3">
        <div class="bg-slate-50 dark:bg-slate-800/50 p-3 rounded-xl border border-slate-100 dark:border-slate-700/50">
            <p class="text-[10px] text-slate-500 uppercase font-bold tracking-tight">Signal Strength</p>
            <p class="text-sm font-semibold">Excellent (4G)</p>
        </div>
        <div class="bg-slate-50 dark:bg-slate-800/50 p-3 rounded-xl border border-slate-100 dark:border-slate-700/50">
            <p class="text-[10px] text-slate-500 uppercase font-bold tracking-tight">Battery Level</p>
            <p class="text-sm font-semibold">84%</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const sosButton = document.getElementById('sosButton');
    const statusMessage = document.getElementById('statusMessage');
    let pressTimer;
    sosButton.addEventListener('mousedown', startPress);
    sosButton.addEventListener('touchstart', startPress);
    sosButton.addEventListener('mouseup', endPress);
    sosButton.addEventListener('mouseleave', endPress);
    sosButton.addEventListener('touchend', endPress);
    function startPress() {
        sosButton.classList.add('scale-90');
        pressTimer = setTimeout(() => { triggerSOS(); }, 1500);
    }
    function endPress() {
        if (statusMessage.classList.contains('hidden')) {
            sosButton.classList.remove('scale-90');
            clearTimeout(pressTimer);
        }
    }
    function triggerSOS() {
        statusMessage.classList.remove('hidden');
        sosButton.innerHTML = '<span class="material-icons-round text-6xl mb-2">check_circle</span><span class="text-lg font-extrabold uppercase tracking-widest px-4 text-center">SOS ACTIVE</span>';
        sosButton.classList.add('bg-emerald-600');
        sosButton.classList.remove('bg-danger');
        if (navigator.vibrate) navigator.vibrate([100, 30, 100, 30, 300]);
        // Send SOS to backend
        fetch('{% url "main:emergency_sos_activation" %}', {
            method: 'POST',
            headers: {'X-CSRFToken': '{{ csrf_token }}', 'Content-Type': 'application/x-www-form-urlencoded'},
            body: 'trigger=1'
        }).then(r => r.json()).then(d => {
            if(d.redirect) window.location.href = d.redirect;
        });
    }
</script>
{% endblock %}
