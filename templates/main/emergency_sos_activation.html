{% extends 'base.html' %}

{% block title %}Emergency SOS Activation - Pravash{% endblock %}

{% block nav_sos_class %}text-danger font-bold{% endblock %}

{% block extra_head %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<style>
    .pulse-animation {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    @keyframes pulse {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.8; transform: scale(0.98); }
    }
    .sos-ripple { position: relative; }
    .sos-ripple::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 100%;
        height: 100%;
        background: #EF4444;
        border-radius: 9999px;
        z-index: -1;
        animation: ripple 2s infinite;
    }
    @keyframes ripple {
        0% { width: 100%; height: 100%; opacity: 0.4; }
        100% { width: 160%; height: 160%; opacity: 0; }
    }
    #sosMap { width: 100%; height: 100%; min-height: 176px; }
    .leaflet-popup-content-wrapper { border-radius: 8px; }
    .leaflet-container { z-index: 1 !important; }
    @keyframes ping {
        75%, 100% {
            transform: translate(-50%, -50%) scale(2);
            opacity: 0;
        }
    }
</style>
{% endblock %}



{% block header %}
<div class="px-6 py-4 flex justify-between items-center">
    <button onclick="history.back()" class="w-10 h-10 flex items-center justify-center rounded-full bg-white dark:bg-zinc-800 ios-shadow">
        <span class="material-icons-round">chevron_left</span>
    </button>
    <h1 class="text-lg font-bold tracking-tight">Emergency SOS</h1>
    <button class="w-10 h-10 flex items-center justify-center rounded-full bg-white dark:bg-zinc-800 ios-shadow text-danger">
        <span class="material-icons-round">info</span>
    </button>
</div>
{% endblock %}

{% block content %}
<!-- SOS Button Area -->
<div class="flex-1 flex flex-col items-center justify-center text-center space-y-12 py-8">
    <div class="space-y-2">
        <h2 class="text-2xl font-bold">Emergency Assistance</h2>
        <p class="text-slate-500 dark:text-slate-400 text-sm leading-relaxed">
            Immediate help will be dispatched. Your location will be shared with the Embassy and your emergency contacts.
        </p>
    </div>
    <div class="relative flex items-center justify-center w-64 h-64">
        <button class="sos-ripple w-52 h-52 bg-danger rounded-full flex flex-col items-center justify-center text-white ios-shadow active:scale-95 transition-transform duration-150 z-10 group" id="sosButton">
            <span class="material-icons-round text-6xl mb-2">emergency</span>
            <span class="text-lg font-extrabold uppercase tracking-widest px-4 text-center">Hold to Activate SOS</span>
        </button>
    </div>
    <div class="hidden flex flex-col items-center space-y-3" id="statusMessage">
        <!-- Phase 1: Sending -->
        <div class="animate-bounce flex items-center space-x-2 bg-red-50 dark:bg-red-900/20 px-4 py-2 rounded-full border border-red-200 dark:border-red-800/50" id="sendingPhase">
            <div class="w-2 h-2 bg-danger rounded-full pulse-animation"></div>
            <p class="text-danger font-semibold text-sm">Sending Location to Embassy & Family...</p>
        </div>
        <!-- Phase 2: Sent confirmation -->
        <div class="hidden flex flex-col items-center space-y-2" id="sentPhase">
            <div class="flex items-center space-x-2 bg-emerald-50 dark:bg-emerald-900/20 px-5 py-2.5 rounded-full border border-emerald-200 dark:border-emerald-800/50">
                <span class="material-icons-round text-emerald-500 text-lg">check_circle</span>
                <p class="text-emerald-600 dark:text-emerald-400 font-semibold text-sm">Location Sent Successfully</p>
            </div>
            <div class="bg-white dark:bg-zinc-800 rounded-2xl p-4 ios-shadow border border-slate-100 dark:border-zinc-700 w-full max-w-xs space-y-2 text-center">
                <p class="text-xs text-slate-500 dark:text-slate-400">Your live location has been shared with:</p>
                <div class="flex items-center justify-center gap-4">
                    <div class="flex flex-col items-center">
                        <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center">
                            <span class="material-icons-round text-primary">account_balance</span>
                        </div>
                        <span class="text-[10px] text-slate-500 mt-1 font-medium">Embassy</span>
                    </div>
                    <div class="flex flex-col items-center">
                        <div class="w-10 h-10 rounded-full bg-red-50 dark:bg-red-900/20 flex items-center justify-center">
                            <span class="material-icons-round text-danger">family_restroom</span>
                        </div>
                        <span class="text-[10px] text-slate-500 mt-1 font-medium">Family</span>
                    </div>
                </div>
                <div class="text-[11px] text-slate-400 mt-2 font-mono" id="sentCoords"></div>
                <p class="text-xs text-emerald-600 dark:text-emerald-400 font-semibold mt-1">Help is on the way!</p>
            </div>
        </div>
    </div>
</div>

<!-- Location Info -->
<div class="bg-white dark:bg-zinc-800 rounded-3xl p-4 ios-shadow space-y-4 mb-6">
    <div class="flex justify-between items-center">
        <div class="flex items-center space-x-2">
            <span class="material-icons-round text-danger">location_on</span>
            <span class="font-semibold">Current Location</span>
        </div>
        <span class="text-[10px] bg-slate-100 dark:bg-slate-800 px-2 py-1 rounded-full text-slate-500">GPS ACTIVE</span>
    </div>
    <div class="relative h-44 rounded-2xl overflow-hidden bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700">
        <div id="sosMap"></div>
        <div class="absolute bottom-3 left-3 bg-white/90 dark:bg-slate-900/90 backdrop-blur-md px-3 py-1.5 rounded-lg text-[11px] font-mono shadow-sm z-[1]">
            <span id="coordsDisplay">Lat: {{ user_lat|floatformat:4 }}&deg;, Lon: {{ user_lon|floatformat:4 }}&deg;</span>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
    // Initialize SOS location map
    let sosLat = {{ user_lat }};
    let sosLon = {{ user_lon }};
    const locationSharing = {{ location_sharing|lower }};
    
    const sosMap = L.map('sosMap', {
        zoomControl: false,
        dragging: false,
        scrollWheelZoom: false,
        doubleClickZoom: false,
        touchZoom: false
    }).setView([sosLat, sosLon], 15);

    // Dark tile layer for emergency context
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap',
        maxZoom: 19,
        className: 'map-tiles'
    }).addTo(sosMap);

    // Pulsing location marker
    const pulseIcon = L.divIcon({
        className: 'custom-pulse-icon',
        html: `<div style="position: relative; width: 32px; height: 32px;">
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                     width: 32px; height: 32px; background: rgba(59, 130, 246, 0.3); 
                     border-radius: 50%; animation: ping 1.5s cubic-bezier(0, 0, 0.2, 1) infinite;"></div>
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                     width: 12px; height: 12px; background: #3B82F6; border: 3px solid white; 
                     border-radius: 50%; box-shadow: 0 2px 8px rgba(0,0,0,0.4);"></div>
              </div>`,
        iconSize: [32, 32],
        iconAnchor: [16, 16]
    });

    let currentMarker = L.marker([sosLat, sosLon], { icon: pulseIcon }).addTo(sosMap);

    // Update coordinates with real location if location sharing is enabled
    if (locationSharing && navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            sosLat = position.coords.latitude;
            sosLon = position.coords.longitude;
            sosMap.setView([sosLat, sosLon], 15);
            
            // Remove old marker and add new one
            sosMap.removeLayer(currentMarker);
            currentMarker = L.marker([sosLat, sosLon], { icon: pulseIcon }).addTo(sosMap);
            
            document.getElementById('coordsDisplay').textContent = 
                `Lat: ${sosLat.toFixed(4)}째, Lon: ${sosLon.toFixed(4)}째`;
        }, function(error) {
            // If geolocation fails, keep default Malaysia location
            console.log('Geolocation error:', error.message);
        });
    }

    setTimeout(() => sosMap.invalidateSize(), 100);
</script>
<script>
    const sosButton = document.getElementById('sosButton');
    const statusMessage = document.getElementById('statusMessage');
    let pressTimer;
    sosButton.addEventListener('mousedown', startPress);
    sosButton.addEventListener('touchstart', startPress);
    sosButton.addEventListener('mouseup', endPress);
    sosButton.addEventListener('mouseleave', endPress);
    sosButton.addEventListener('touchend', endPress);
    function startPress() {
        sosButton.classList.add('scale-90');
        pressTimer = setTimeout(() => { triggerSOS(); }, 1500);
    }
    function endPress() {
        if (statusMessage.classList.contains('hidden')) {
            sosButton.classList.remove('scale-90');
            clearTimeout(pressTimer);
        }
    }
    function triggerSOS() {
        statusMessage.classList.remove('hidden');
        sosButton.innerHTML = '<span class="material-icons-round text-6xl mb-2">check_circle</span><span class="text-lg font-extrabold uppercase tracking-widest px-4 text-center">SOS ACTIVE</span>';
        sosButton.classList.add('bg-emerald-600');
        sosButton.classList.remove('bg-danger');
        if (navigator.vibrate) navigator.vibrate([100, 30, 100, 30, 300]);

        // Build body with current live location
        const body = `trigger=1&latitude=${sosLat}&longitude=${sosLon}`;

        // Send SOS to backend
        fetch('{% url "main:emergency_sos_activation" %}', {
            method: 'POST',
            headers: {'X-CSRFToken': '{{ csrf_token }}', 'Content-Type': 'application/x-www-form-urlencoded'},
            body: body
        }).then(r => r.json()).then(d => {
            // Phase 2: Show sent confirmation
            document.getElementById('sendingPhase').classList.add('hidden');
            const sentPhase = document.getElementById('sentPhase');
            sentPhase.classList.remove('hidden');
            document.getElementById('sentCoords').textContent = `Lat: ${sosLat.toFixed(4)}째, Lon: ${sosLon.toFixed(4)}째`;
        }).catch(err => {
            document.getElementById('sendingPhase').innerHTML = '<div class="w-2 h-2 bg-danger rounded-full pulse-animation"></div><p class="text-danger font-semibold text-sm">Failed to send. Retrying...</p>';
        });
    }
</script>
{% endblock %}
