{% extends 'base.html' %}

{% block title %}Family Dashboard - Pravash{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<style>
    .leaflet-container { height:100%; width:100%; border-radius:1rem; }
    @keyframes softPulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.06)} }
    .pulse-ring { animation: ringPulse 2s infinite; }
    @keyframes ringPulse {
        0%   { box-shadow: 0 0 0 0 rgba(124,179,66,.5); }
        70%  { box-shadow: 0 0 0 14px rgba(124,179,66,0); }
        100% { box-shadow: 0 0 0 0 rgba(124,179,66,0); }
    }
    .pulse-ring-danger { animation: ringDanger 2s infinite; }
    @keyframes ringDanger {
        0%   { box-shadow: 0 0 0 0 rgba(239,68,68,.5); }
        70%  { box-shadow: 0 0 0 14px rgba(239,68,68,0); }
        100% { box-shadow: 0 0 0 0 rgba(239,68,68,0); }
    }
    .streak-fire { animation: softPulse 2s ease-in-out infinite; }
</style>
{% endblock %}

{% block header %}
<header class="sticky top-0 z-20 bg-background-light/80 dark:bg-background-dark/80 backdrop-blur-xl border-b border-slate-100 dark:border-zinc-800 px-5 py-3 flex items-center justify-between">
    <div class="flex items-center gap-2.5">
        <button onclick="history.back()" class="w-9 h-9 rounded-full bg-white dark:bg-zinc-800 flex items-center justify-center ios-shadow">
            <span class="material-icons-round text-slate-600 dark:text-slate-300">chevron_left</span>
        </button>
        <div>
            <h1 class="text-lg font-bold leading-tight">Family Dashboard</h1>
            <p class="text-[11px] text-slate-400">Monitor your loved one's safety</p>
        </div>
    </div>
    <a href="{% url 'main:safety_notifications' %}" class="relative w-9 h-9 rounded-full bg-white dark:bg-zinc-800 flex items-center justify-center ios-shadow">
        <span class="material-icons-round text-slate-500 text-lg">notifications</span>
        {% if unread_count %}
        <div class="absolute top-0 right-0 w-2.5 h-2.5 bg-danger border-2 border-white dark:border-zinc-900 rounded-full"></div>
        {% endif %}
    </a>
</header>
{% endblock %}

{% block content %}
{% if worker %}

{% if active_sos %}
<!-- SOS Emergency Alert Banner -->
<div class="bg-red-600 rounded-3xl ios-shadow p-5 mb-4 text-white relative overflow-hidden">
    <div class="absolute -top-6 -right-6 w-28 h-28 bg-red-500/30 rounded-full blur-xl"></div>
    <div class="absolute -bottom-4 -left-4 w-20 h-20 bg-red-400/20 rounded-full blur-lg"></div>
    <div class="relative z-10">
        <div class="flex items-center gap-3 mb-3">
            <div class="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center pulse-ring-danger">
                <span class="material-icons-round text-2xl">emergency</span>
            </div>
            <div>
                <h3 class="text-lg font-extrabold">SOS ALERT</h3>
                <p class="text-xs text-red-100">{{ active_sos.activated_at|timesince }} ago</p>
            </div>
        </div>
        <p class="text-sm font-semibold leading-relaxed mb-1">
            {{ worker.get_full_name|default:worker.username }} is in trouble and needs help!
        </p>
        <p class="text-xs text-red-100 mb-4">
            An emergency SOS was activated. Their live location has been shared.
            {% if active_sos.latitude and active_sos.longitude %}
            <span class="block mt-1 font-mono text-[11px]">üìç Lat: {{ active_sos.latitude|floatformat:4 }}¬∞, Lon: {{ active_sos.longitude|floatformat:4 }}¬∞</span>
            {% endif %}
        </p>
        {% if nearest_embassy %}
        <a href="tel:{{ nearest_embassy.emergency_hotline|default:nearest_embassy.phone }}" class="flex items-center justify-center gap-2 bg-white text-red-600 font-bold py-3 rounded-2xl active:scale-95 transition-transform w-full">
            <span class="material-icons-round">call</span>
            Call Embassy Now ‚Äî {{ nearest_embassy.name }}
        </a>
        {% else %}
        <a href="{% url 'main:embassy_contact_directory' %}" class="flex items-center justify-center gap-2 bg-white text-red-600 font-bold py-3 rounded-2xl active:scale-95 transition-transform w-full">
            <span class="material-icons-round">account_balance</span>
            Contact Nearest Embassy
        </a>
        {% endif %}
        <a href="tel:{{ worker.phone }}" class="flex items-center justify-center gap-2 bg-white/20 text-white font-bold py-3 rounded-2xl active:scale-95 transition-transform w-full mt-2">
            <span class="material-icons-round">call</span>
            Call {{ worker.first_name|default:'Worker' }}
        </a>
    </div>
</div>
{% endif %}

<!-- Worker Profile Card -->
<div class="bg-white dark:bg-zinc-900 rounded-3xl ios-shadow border border-slate-100 dark:border-zinc-800 p-5 flex flex-col items-center text-center relative overflow-hidden">
    <div class="absolute inset-0 bg-gradient-to-b {% if is_safe %}from-emerald-50/60 to-transparent{% else %}from-red-50/60 to-transparent{% endif %} dark:from-transparent pointer-events-none"></div>

    <div class="relative z-10">
        <!-- Worker Photo with pulse ring -->
        <div class="relative inline-block">
            {% if worker.photo %}
            <div class="w-28 h-28 rounded-full bg-cover bg-center border-4 {% if is_safe %}border-emerald-300 pulse-ring{% else %}border-red-400 pulse-ring-danger{% endif %}" style='background-image: url("{{ worker.photo.url }}")'></div>
            {% else %}
            <div class="w-28 h-28 rounded-full {% if is_safe %}border-emerald-300 pulse-ring bg-emerald-50{% else %}border-red-400 pulse-ring-danger bg-red-50{% endif %} border-4 flex items-center justify-center">
                <span class="text-4xl font-bold {% if is_safe %}text-emerald-600{% else %}text-red-500{% endif %}">{{ worker.first_name|make_list|first|default:'W' }}{{ worker.last_name|make_list|first|default:'' }}</span>
            </div>
            {% endif %}
            <div class="absolute -bottom-1 -right-1 w-9 h-9 rounded-full {% if is_safe %}bg-emerald-500{% else %}bg-red-500{% endif %} flex items-center justify-center ring-4 ring-white dark:ring-zinc-900">
                <span class="material-icons-round text-white text-lg">{% if is_safe %}check{% else %}warning{% endif %}</span>
            </div>
        </div>

        <h2 class="mt-4 text-xl font-extrabold">{{ worker.get_full_name|default:worker.username }}</h2>
        <p class="mt-1 text-sm font-semibold {% if is_safe %}text-emerald-600{% else %}text-red-500{% endif %}">
            {% if active_sos %}üö® Emergency SOS Active{% elif is_safe %}Safe & Sound{% else %}Needs Attention{% endif %}
        </p>
        <div class="flex items-center justify-center gap-1 mt-1.5 text-xs text-slate-400">
            <span class="material-icons-round text-sm">location_on</span>
            {{ worker.current_city|default:'Kuala Lumpur' }}, {{ display_country }}
        </div>
    </div>
</div>

<!-- Stats Row -->
<div class="grid grid-cols-3 gap-3 mt-4">
    <div class="bg-white dark:bg-zinc-900 rounded-2xl ios-shadow border border-slate-100 dark:border-zinc-800 p-3 text-center">
        <span class="material-icons-round text-primary text-xl">schedule</span>
        <p class="text-[10px] text-slate-400 mt-1 font-semibold uppercase">Last Check-in</p>
        {% if last_checkin %}
        <p class="text-xs font-bold mt-0.5">{{ last_checkin.checked_in_at|date:"g:i A" }}</p>
        <p class="text-[10px] text-slate-400">{{ last_checkin.checked_in_at|date:"M d" }}</p>
        {% else %}
        <p class="text-xs font-bold mt-0.5 text-slate-300">‚Äî</p>
        {% endif %}
    </div>
    <div class="bg-white dark:bg-zinc-900 rounded-2xl ios-shadow border border-slate-100 dark:border-zinc-800 p-3 text-center">
        <div class="streak-fire text-xl">üî•</div>
        <p class="text-[10px] text-slate-400 mt-1 font-semibold uppercase">Streak</p>
        <p class="text-lg font-extrabold text-primary mt-0.5 leading-none">{{ streak }}</p>
        <p class="text-[10px] text-slate-400">day{{ streak|pluralize }}</p>
    </div>
    <div class="bg-white dark:bg-zinc-900 rounded-2xl ios-shadow border border-slate-100 dark:border-zinc-800 p-3 text-center">
        <span class="material-icons-round {% if is_safe %}text-emerald-500{% else %}text-red-500{% endif %} text-xl">{% if is_safe %}verified_user{% else %}error{% endif %}</span>
        <p class="text-[10px] text-slate-400 mt-1 font-semibold uppercase">Status</p>
        <p class="text-xs font-bold mt-0.5 {% if is_safe %}text-emerald-600{% else %}text-red-500{% endif %}">{% if is_safe %}Safe{% else %}Help{% endif %}</p>
    </div>
</div>

<!-- Weekly Calendar Strip -->
<div class="mt-4 bg-white dark:bg-zinc-900 rounded-2xl ios-shadow border border-slate-100 dark:border-zinc-800 p-4">
    <div class="flex items-center justify-between mb-3">
        <h3 class="text-sm font-bold">This Week's Check-ins</h3>
        <span class="text-xs text-slate-400">{{ streak }} day streak üî•</span>
    </div>
    <div class="grid grid-cols-7 gap-1.5">
        {% for day in week_data %}
        <div class="flex flex-col items-center gap-1">
            <span class="text-[10px] font-medium {% if day.is_today %}text-primary{% else %}text-slate-400{% endif %}">{{ day.day_name }}</span>
            <div class="w-9 h-9 rounded-xl flex items-center justify-center text-sm font-bold
                {% if day.checked and day.is_today %}bg-primary text-white
                {% elif day.checked %}bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600
                {% elif day.is_today %}bg-primary/10 text-primary border-2 border-primary/30
                {% else %}bg-slate-100 dark:bg-zinc-800 text-slate-300{% endif %}">
                {% if day.checked %}
                <span class="material-icons-round text-sm">check</span>
                {% else %}
                {{ day.day_num }}
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Last Check-in Location Map -->
<div class="mt-4 bg-white dark:bg-zinc-900 rounded-2xl ios-shadow border border-slate-100 dark:border-zinc-800 overflow-hidden">
    <div class="flex items-center justify-between px-4 py-3 border-b border-slate-100 dark:border-zinc-800">
        <div class="flex items-center gap-2">
            <span class="material-icons-round text-primary text-lg">location_on</span>
            <h3 class="text-sm font-bold">Last Known Location</h3>
        </div>
        {% if last_checkin %}
        <span class="text-[10px] font-medium text-slate-400">{{ last_checkin.checked_in_at|timesince }} ago</span>
        {% endif %}
    </div>
    <div id="family-map" class="h-48 w-full"></div>
    <div class="px-4 py-2.5 bg-slate-50 dark:bg-zinc-800/50 flex items-center gap-2 text-xs text-slate-500">
        <span class="material-icons-round text-sm text-primary">my_location</span>
        {{ worker.current_city|default:'Kuala Lumpur' }}, {{ display_country }}
        {% if last_checkin %}
        <span class="mx-1">¬∑</span>
        {{ last_checkin.checked_in_at|date:"M d, Y - g:i A" }}
        {% endif %}
    </div>
</div>

<!-- Quick Actions -->
<div class="grid grid-cols-2 gap-3 mt-4 mb-6">
    <a href="tel:{{ worker.phone }}" class="flex items-center gap-3 bg-primary rounded-2xl p-4 text-white active:scale-95 transition-transform ios-shadow">
        <span class="material-icons-round text-2xl">call</span>
        <div>
            <p class="text-sm font-bold">Call</p>
            <p class="text-[10px] opacity-80">{{ worker.first_name|default:'Worker' }}</p>
        </div>
    </a>
    <a href="{% url 'main:embassy_contact_directory' %}" class="flex items-center gap-3 bg-white dark:bg-zinc-900 rounded-2xl p-4 text-slate-700 dark:text-slate-300 active:scale-95 transition-transform ios-shadow border border-slate-100 dark:border-zinc-800">
        <span class="material-icons-round text-2xl text-primary">account_balance</span>
        <div>
            <p class="text-sm font-bold">Embassy</p>
            <p class="text-[10px] text-slate-400">Get Help</p>
        </div>
    </a>
</div>

<!-- Recent Check-in History -->
<div class="mt-4 mb-6">
    <h3 class="text-sm font-bold mb-3">Recent Check-ins</h3>
    <div class="bg-white dark:bg-zinc-900 rounded-2xl ios-shadow border border-slate-100 dark:border-zinc-800 divide-y divide-slate-100 dark:divide-zinc-800">
        {% for ci in recent_checkins %}
        <div class="flex items-center gap-3 px-4 py-3">
            <div class="w-9 h-9 rounded-xl flex items-center justify-center
                {% if ci.status == 'safe' %}bg-emerald-100 dark:bg-emerald-900/30{% else %}bg-red-100 dark:bg-red-900/30{% endif %}">
                <span class="material-icons-round text-lg {% if ci.status == 'safe' %}text-emerald-500{% else %}text-red-500{% endif %}">
                    {% if ci.status == 'safe' %}check_circle{% else %}warning{% endif %}
                </span>
            </div>
            <div class="flex-1">
                <p class="text-sm font-semibold {% if ci.status == 'safe' %}text-emerald-700 dark:text-emerald-400{% else %}text-red-600{% endif %}">
                    {{ ci.get_status_display }}
                </p>
                <p class="text-[11px] text-slate-400">{{ ci.checked_in_at|date:"M d, Y - g:i A" }}</p>
            </div>
            <span class="text-[10px] text-slate-400 whitespace-nowrap">{{ ci.checked_in_at|timesince }} ago</span>
        </div>
        {% empty %}
        <div class="py-8 text-center">
            <span class="material-icons-round text-slate-200 text-4xl">event_busy</span>
            <p class="text-sm text-slate-400 mt-2">No check-ins recorded yet</p>
        </div>
        {% endfor %}
    </div>
</div>

{% else %}
<!-- No Worker Linked -->
<div class="mt-10 flex flex-col items-center text-center px-6">
    <div class="w-24 h-24 rounded-full bg-slate-100 dark:bg-zinc-800 flex items-center justify-center mb-4">
        <span class="material-icons-round text-slate-300 text-5xl">person_off</span>
    </div>
    <h2 class="text-xl font-extrabold">No Worker Linked</h2>
    <p class="text-sm text-slate-400 mt-2 max-w-xs">Ask your family member to link your account from their profile settings so you can monitor their safety.</p>
</div>
{% endif %}

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
(function(){
    var mapEl = document.getElementById('family-map');
    if (!mapEl) return;

    var lat = {{ worker_lat }};
    var lon = {{ worker_lon }};
    var sharing = {{ location_sharing|yesno:"true,false" }};

    var map = L.map('family-map', {
        center: [lat, lon],
        zoom: 14,
        zoomControl: false,
        scrollWheelZoom: false,
        dragging: true,
    });

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OSM',
        maxZoom: 19
    }).addTo(map);

    var pulseIcon = L.divIcon({
        className: '',
        html: '<div style="position:relative;width:34px;height:34px">' +
              '<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:34px;height:34px;border-radius:50%;background:rgba(124,179,66,.25);animation:mp 2s infinite"></div>' +
              '<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:14px;height:14px;border-radius:50%;background:#7CB342;border:3px solid #fff;box-shadow:0 2px 8px rgba(0,0,0,.3)"></div>' +
              '</div>' +
              '<style>@keyframes mp{0%{transform:translate(-50%,-50%) scale(1);opacity:1}100%{transform:translate(-50%,-50%) scale(2.5);opacity:0}}</style>',
        iconSize: [34, 34],
        iconAnchor: [17, 17]
    });

    var marker = L.marker([lat, lon], { icon: pulseIcon })
        .addTo(map)
        .bindPopup('<b>{{ worker.first_name|default:"Worker" }}\'s Location</b><br>{{ display_country }}');

    if (sharing && navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(pos) {
            var rlat = pos.coords.latitude;
            var rlon = pos.coords.longitude;
            map.setView([rlat, rlon], 14);
            map.removeLayer(marker);
            marker = L.marker([rlat, rlon], { icon: pulseIcon })
                .addTo(map)
                .bindPopup('<b>{{ worker.first_name|default:"Worker" }}\'s Location</b>');
        });
    }
})();
</script>
{% endblock %}
