{% extends 'base.html' %}

{% block title %}Document Vault - Pravash{% endblock %}

{% block extra_head %}
<style>
    .vault-progress {
        background: conic-gradient(#7CB342 0deg, #7CB342 180deg, #e2e8f0 180deg, #e2e8f0 360deg);
    }
</style>
{% endblock %}



{% block header %}
<header class="sticky top-0 z-20 bg-background-light/80 dark:bg-background-dark/80 backdrop-blur-xl border-b border-slate-100 dark:border-slate-800 px-6 py-3">
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-xl font-bold tracking-tight">Document Vault</h1>
            <p class="text-xs text-slate-400 flex items-center gap-1 mt-0.5">
                <span class="material-icons-round text-success text-sm">lock</span>
                End-to-end encrypted
            </p>
        </div>
        <div class="flex items-center gap-2">
            <div class="relative w-10 h-10">
                {% with total=uploaded_docs|length plus_pending=pending_types|length %}
                <div class="w-full h-full rounded-full flex items-center justify-center" style="background: conic-gradient(#7CB342 0deg, #7CB342 {{ uploaded_docs|length|floatformat:0 }}deg, #e2e8f0 {{ uploaded_docs|length|floatformat:0 }}deg, #e2e8f0 360deg)">
                    <div class="w-7 h-7 rounded-full bg-background-light dark:bg-background-dark flex items-center justify-center text-[10px] font-extrabold">{{ uploaded_docs|length }}/{{ doc_total }}</div>
                </div>
                {% endwith %}
            </div>
        </div>
    </div>
</header>
{% endblock %}

{% block content %}
<!-- Uploaded Documents -->
<section id="uploaded-docs">
    <h2 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-3">Uploaded</h2>
    <div class="space-y-3">
        {% for doc in uploaded_docs %}
        <div class="bg-white dark:bg-zinc-900 p-4 rounded-2xl ios-shadow border border-slate-100 dark:border-zinc-800 flex items-center gap-4">
            <div class="w-12 h-12 rounded-2xl {% if doc.doc_type == 'passport' %}bg-primary/10 dark:bg-primary/20 text-primary{% elif doc.doc_type == 'visa' %}bg-info/10 dark:bg-info/20 text-info{% elif doc.doc_type == 'contract' %}bg-warning/10 text-warning{% else %}bg-slate-100 dark:bg-zinc-800 text-slate-400{% endif %} flex items-center justify-center">
                <span class="material-symbols-outlined text-2xl">{% if doc.doc_type == 'passport' %}badge{% elif doc.doc_type == 'visa' %}flight{% elif doc.doc_type == 'contract' %}description{% elif doc.doc_type == 'citizenship' %}id_card{% elif doc.doc_type == 'insurance' %}health_and_safety{% else %}folder{% endif %}</span>
            </div>
            <div class="flex-1">
                <h3 class="font-bold text-sm">{{ doc.get_doc_type_display }}</h3>
                <p class="text-[11px] text-slate-400 mt-0.5">Uploaded {{ doc.uploaded_at|date:'d M Y' }} · {{ doc.get_verification_status_display }}</p>
            </div>
            <div class="flex items-center gap-2">
                {% if doc.verification_status == 'verified' %}
                <span class="material-icons-round text-success text-lg">verified</span>
                {% elif doc.verification_status == 'pending' %}
                <span class="material-icons-round text-warning text-lg">pending</span>
                {% else %}
                <span class="material-icons-round text-danger text-lg">cancel</span>
                {% endif %}
                <a href="{% url 'main:document_download' doc.pk %}" class="text-xs bg-white/10 border rounded-lg px-2 py-1">Download</a>
                <form method="post" action="{% url 'main:document_delete' doc.pk %}" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" class="text-xs bg-red-50 text-red-700 border rounded-lg px-2 py-1">Delete</button>
                </form>
            </div>
        </div>
        {% empty %}
        <div class="text-center py-4">
            <p class="text-sm text-slate-400">No documents uploaded yet.</p>
        </div>
        {% endfor %}
    </div>
</section>

<!-- Pending Documents -->
{% if pending_types %}
<section class="mt-6">
    <h2 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-3">Pending Upload</h2>
    <div class="space-y-3">
        {% for pt in pending_types %}
        <form method="post" enctype="multipart/form-data" class="pending-upload-form bg-white/60 dark:bg-zinc-900/40 p-4 rounded-2xl border-2 border-dashed border-slate-300 dark:border-zinc-600 flex items-center gap-4">
            {% csrf_token %}
            <input type="hidden" name="doc_type" value="{{ pt.value }}" />
            <div class="w-12 h-12 rounded-2xl {% if pt.value == 'contract' %}bg-warning/10 text-warning{% elif pt.value == 'citizenship' %}bg-slate-100 dark:bg-zinc-800 text-slate-400{% elif pt.value == 'insurance' %}bg-info/10 text-info{% else %}bg-primary/10 text-primary{% endif %} flex items-center justify-center">
                <span class="material-symbols-outlined text-2xl">{% if pt.value == 'contract' %}description{% elif pt.value == 'citizenship' %}id_card{% elif pt.value == 'insurance' %}health_and_safety{% elif pt.value == 'passport' %}badge{% elif pt.value == 'visa' %}flight{% else %}folder{% endif %}</span>
            </div>
            <div class="flex-1">
                <h3 class="font-bold text-sm">{{ pt.label }}</h3>
                <input type="file" name="file" accept=".pdf,.jpg,.jpeg,.png" required class="text-[11px] text-slate-400 mt-1 file:mr-2 file:py-1 file:px-2 file:rounded-lg file:border-0 file:text-[10px] file:font-bold file:bg-primary/10 file:text-primary w-full" />
            </div>
            <button type="submit" class="bg-primary text-white text-xs font-bold px-3 py-2 rounded-xl active:scale-95 transition-all">Upload</button>
        </form>
        {% endfor %}
    </div>
</section>
{% endif %}

<!-- Security Info -->
<section class="mt-6 mb-6 p-4 rounded-2xl bg-primary/5 dark:bg-primary/10 border border-primary/20">
    <div class="flex items-start gap-3">
        <span class="material-symbols-outlined text-primary text-xl mt-0.5">shield</span>
        <div>
            <h3 class="text-sm font-bold">Your Documents Are Secure</h3>
            <p class="text-xs text-slate-500 dark:text-slate-400 mt-1 leading-relaxed">All documents are encrypted with AES-256 and stored securely. Only you and authorized contacts can access them.</p>
        </div>
    </div>
</section>

<!-- Floating Upload FAB -->
<button class="fixed bottom-24 right-6 w-14 h-14 rounded-full bg-primary text-white shadow-xl shadow-primary/30 flex items-center justify-center active:scale-90 transition-all z-30">
    <span class="material-icons-round text-2xl">add</span>
</button>

<script>
// Intercept pending upload forms and upload via AJAX for dynamic UI
document.addEventListener('DOMContentLoaded', function () {
    const forms = document.querySelectorAll('.pending-upload-form');
    forms.forEach(form => {
        form.addEventListener('submit', async function (e) {
            e.preventDefault();
            const submit = form.querySelector('button[type=submit]');
            submit.disabled = true;
            const fd = new FormData(form);
            try {
                const res = await fetch("{% url 'main:document_upload_ajax' %}", {
                    method: 'POST',
                    body: fd,
                });
                const data = await res.json();
                if (data.ok) {
                    const d = data.doc;
                    // build uploaded doc node
                    const container = document.querySelector('#uploaded-docs .space-y-3');
                    if (container) {
                        const node = document.createElement('div');
                        node.className = 'bg-white dark:bg-zinc-900 p-4 rounded-2xl ios-shadow border border-slate-100 dark:border-zinc-800 flex items-center gap-4';
                        node.innerHTML = `
                            <div class="w-12 h-12 rounded-2xl bg-primary/10 text-primary flex items-center justify-center">
                                <span class="material-symbols-outlined text-2xl">folder</span>
                            </div>
                            <div class="flex-1">
                                <h3 class="font-bold text-sm">${d.doc_label}</h3>
                                <p class="text-[11px] text-slate-400 mt-0.5">Uploaded ${d.uploaded_at} · ${d.verification_status}</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <a href="${d.download_url}" class="text-xs bg-white/10 border rounded-lg px-2 py-1">Download</a>
                                <form method="post" action="${d.delete_url}" style="display:inline;">
                                    <input type="hidden" name="csrfmiddlewaretoken" value="${fd.get('csrfmiddlewaretoken')}" />
                                    <button type="submit" class="text-xs bg-red-50 text-red-700 border rounded-lg px-2 py-1">Delete</button>
                                </form>
                            </div>
                        `;
                        container.prepend(node);
                    }
                    // remove the pending form for this type
                    form.remove();
                } else {
                    alert('Upload failed')
                }
            } catch (err) {
                console.error(err);
                alert('Upload error');
            } finally {
                submit.disabled = false;
            }
        });
    });
});
</script>
{% endblock %}
